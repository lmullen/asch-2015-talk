<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="d3map.css">
    <link rel="stylesheet" href="style.css">

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>
    <script src="d3.carto.map.js" charset="utf-8"></script>
    <script src="tile.js" charset="utf-8"></script>
    <script src="stack.v1.min.js"></script>

<section>
  <h3>This is the title</h3>
  <p>This is the body here</p>
</section>

<section style="background-image:url('gaustad-congregationalists.jpg'); 
  background-size: contain; background-repeat: no-repeat; 
  background-position: center;">
</section>

<section id="gaustad-slide">
  <h2> Gaustad map</h2>
  <div id="gaustad-map" class="map">
  </div>
</section>

<section id="congregationalists">
  <h2>Congregationalists in 1854</h2>
  <div id="congregationalists-map" class="map">
  </div>
</section>

<section id="diachronic">
  <h2>Congregationalists in <span 
      id="diachronic-date">1620</span>
  </h2>
  <div id="diachronic-map" class="map">
  </div>
</section>

<script>

var mystack = stack()
    .on("activate", activate)
    .on("deactivate", deactivate);

function drawCongregationalists() {
  congregationalistsMap = d3.carto.map();
  d3.select("#congregationalists-map").call(congregationalistsMap);
  congregationalistsMap
  .centerOn([-71.668006, 42.239650], "latlong")
  .setScale(8);
  

  baseLayer = d3.carto.layer.tile();
  baseLayer
  .path("terrain-background")
  .tileType("stamen")
  .label("Base");

  churches = d3.carto.layer.csv();

  churches
  .path("congregationalists.csv")
  .label("Churches")
  .cssClass("church")
  .renderMode("svg")
  .x("lon")
  .y("lat")
  .markerSize(0)
  .clickableFeatures(false)
  .on("load", scaleChurchCircles);

  congregationalistsMap
  .addCartoLayer(baseLayer)
  .addCartoLayer(churches)
  .zoomable(false);

}


function drawDiachronic() {
  diachronicMap = d3.carto.map();
  d3.select("#diachronic-map").call(diachronicMap);
  diachronicMap
  .centerOn([-71.668006, 42.239650], "latlong")
  .setScale(8);
  

  baseLayer = d3.carto.layer.tile();
  baseLayer
  .path("terrain-background")
  .tileType("stamen")
  .label("Base");

  churchesDiachronic = d3.carto.layer.csv();

  churchesDiachronic
  .path("congregationalists.csv")
  .label("Churches")
  .cssClass("church")
  .renderMode("svg")
  .x("lon")
  .y("lat")
  .markerSize(0)
  .clickableFeatures(false)
  .on("load", churchesOverTime);

  diachronicMap
  .addCartoLayer(baseLayer)
  .addCartoLayer(churchesDiachronic)
  .zoomable(false);

}

function churchesOverTime() {

  var date = 1620;

  timer = setInterval(function() {

    churchesDiachronic.g().selectAll("circle")
      .transition()
      .attr("r", function(d) {
        if(+d.organized <= date) 
          return 5;
        else
          return 0;
      })
      .duration(250)
      .ease("linear");

    date++;
    d3.select("#diachronic-date").text(date);

    if(date >= 1854) clearInterval(timer);

    }, 250)
}

function scaleChurchCircles() {
  var memberScale = d3.scale.sqrt().domain([0,800]).range([0,15]).clamp(true);
  churches.g().selectAll("circle")
  .transition()
  .attr("r", function(d) {
     if(d.members > 0) {
       return memberScale(d.members);
     } else {
       return 1;
     }
  })
  .duration(2500)
  .delay(function(d, i) { return i / 500 * 2500; });

}

function drawGaustad() {
  gaustadMap = d3.carto.map();
  d3.select("#gaustad-map").call(gaustadMap);
  gaustadMap.centerOn([-71.668006, 42.239650], "latlong").setScale(8);

  census = d3.carto.layer.topojson();
  census
  .path("census.topojson")
  .label("Census")
  .renderMode("svg")
  .cssClass("census")
  .clickableFeatures(false)
  .on("load", choroplethCensus);

  gaustadMap.addCartoLayer(census);

}

function choroplethCensus() {
  var censusScale = d3.scale.linear().domain([0, 75]).range(["white", "red"]);
  census.g().selectAll("path").style("fill", function(d) {
    return censusScale(d.properties.cong);
  }).style("fill-opacity", 1);
}

function deleteCongregationalists() {
  d3.select("#congregationalists-map").selectAll("*").remove();
}

function deleteDiachronic() {
  clearInterval(timer);
  d3.select("#diachronic-map").selectAll("*").remove();
}

function deleteGaustad() {
  d3.select("#gaustad-map").selectAll("*").remove();
}

var section = d3.selectAll("section"),
    congregationalistsNode = d3.select("#congregationalists"),
    congregationalistsIndex = section[0].indexOf(congregationalistsNode.node());
    diachronicNode = d3.select("#diachronic"),
    diachronicIndex = section[0].indexOf(diachronicNode.node());
    gaustadNode = d3.select("#gaustad-slide"),
    gaustadIndex = section[0].indexOf(gaustadNode.node());

function refollow() {
  followAnchor.style("top", (followIndex + (1 - mystack.scrollRatio()) / 2 - d3.event.offset) * 100 + "%");
}

function activate(d, i) {
 if (i === congregationalistsIndex) drawCongregationalists();
 if (i === diachronicIndex) drawDiachronic();
 if (i === gaustadIndex) drawGaustad();
}

function deactivate(d, i) {
 if (i === congregationalistsIndex) deleteCongregationalists();
 if (i === diachronicIndex) deleteDiachronic();
 if (i === gaustadIndex) deleteGaustad();
}

</script>
